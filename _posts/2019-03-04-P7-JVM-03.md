---
layout:     post
title:      æ·±å…¥ç†è§£JVM03
subtitle:    "\"è™šæ‹Ÿæœºæ€§èƒ½ç›‘æ§ä¸æ•…éšœå¤„ç†å·¥å…·\""
date:       2019-03-04
author:     Lin
header-img: img/post-bg-keybord.jpg
catalog: true
tags:
    - java
    - jvm
---

"ğŸ™ŠğŸ™ŠğŸ™ŠThis tutorial is experimental and unsupported."

#### ä¸ŠæœŸè¯¾åä½œä¸šç»å…¸å›ç­”

* é—®é¢˜: Java å¸¸è§çš„åƒåœ¾æ”¶é›†å™¨æœ‰å“ªäº›ï¼Ÿ

å®é™…ä¸Šï¼Œåƒåœ¾æ”¶é›†å™¨ï¼ˆGCï¼ŒGarbage Collectorï¼‰æ˜¯å’Œå…·ä½“ JVM å®ç°ç´§å¯†ç›¸å…³çš„ï¼Œä¸åŒå‚å•†ï¼ˆIBMã€Oracleï¼‰ï¼Œä¸åŒç‰ˆæœ¬çš„ JVMï¼Œæä¾›çš„é€‰æ‹©ä¹Ÿä¸åŒã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘æ¥è°ˆè°ˆæœ€ä¸»æµçš„ Oracle JDKã€‚

* Serial GCï¼Œå®ƒæ˜¯æœ€å¤è€çš„åƒåœ¾æ”¶é›†å™¨ï¼Œâ€œSerialâ€ä½“ç°åœ¨å…¶æ”¶é›†å·¥ä½œæ˜¯å•çº¿ç¨‹çš„ï¼Œå¹¶ä¸”åœ¨è¿›è¡Œåƒåœ¾æ”¶é›†è¿‡ç¨‹ä¸­ï¼Œä¼šè¿›å…¥è‡­åæ˜­è‘—çš„â€œStop-The-Worldâ€çŠ¶æ€ã€‚å½“ç„¶ï¼Œå…¶å•çº¿ç¨‹è®¾è®¡ä¹Ÿæ„å‘³ç€ç²¾ç®€çš„ GC å®ç°ï¼Œæ— éœ€ç»´æŠ¤å¤æ‚çš„æ•°æ®ç»“æ„ï¼Œåˆå§‹åŒ–ä¹Ÿç®€å•ï¼Œæ‰€ä»¥ä¸€ç›´æ˜¯ Client æ¨¡å¼ä¸‹ JVM çš„é»˜è®¤é€‰é¡¹ã€‚ä»å¹´ä»£çš„è§’åº¦ï¼Œé€šå¸¸å°†å…¶è€å¹´ä»£å®ç°å•ç‹¬ç§°ä½œ Serial Oldï¼Œå®ƒé‡‡ç”¨äº†æ ‡è®° - æ•´ç†ï¼ˆMark-Compactï¼‰ç®—æ³•ï¼ŒåŒºåˆ«äºæ–°ç”Ÿä»£çš„å¤åˆ¶ç®—æ³•ã€‚

```
-XX:UseSerialGC
```

* ParNew GCï¼Œå¾ˆæ˜æ˜¾æ˜¯ä¸ªæ–°ç”Ÿä»£ GC å®ç°ï¼Œå®ƒå®é™…æ˜¯ Serial GC çš„å¤šçº¿ç¨‹ç‰ˆæœ¬ï¼Œæœ€å¸¸è§çš„åº”ç”¨åœºæ™¯æ˜¯é…åˆè€å¹´ä»£çš„ CMS GC å·¥ä½œï¼Œä¸‹é¢æ˜¯å¯¹åº”å‚æ•°

```
-XX:+UseConcMarkSweepGC -XX:+UseParNewGC
```

* CMSï¼ˆConcurrent Mark Sweepï¼‰ GCï¼ŒåŸºäºæ ‡è®° - æ¸…é™¤ï¼ˆMark-Sweepï¼‰ç®—æ³•ï¼Œè®¾è®¡ç›®æ ‡æ˜¯å°½é‡å‡å°‘åœé¡¿æ—¶é—´ï¼Œè¿™ä¸€ç‚¹å¯¹äº Web ç­‰ååº”æ—¶é—´æ•æ„Ÿçš„åº”ç”¨éå¸¸é‡è¦ï¼Œä¸€ç›´åˆ°ä»Šå¤©ï¼Œä»ç„¶æœ‰å¾ˆå¤šç³»ç»Ÿä½¿ç”¨ CMS GCã€‚ä½†æ˜¯ï¼ŒCMS é‡‡ç”¨çš„æ ‡è®° - æ¸…é™¤ç®—æ³•ï¼Œå­˜åœ¨ç€å†…å­˜ç¢ç‰‡åŒ–é—®é¢˜ï¼Œæ‰€ä»¥éš¾ä»¥é¿å…åœ¨é•¿æ—¶é—´è¿è¡Œç­‰æƒ…å†µä¸‹å‘ç”Ÿ full GCï¼Œå¯¼è‡´æ¶åŠ£çš„åœé¡¿ã€‚å¦å¤–ï¼Œæ—¢ç„¶å¼ºè°ƒäº†å¹¶å‘ï¼ˆConcurrentï¼‰ï¼ŒCMS ä¼šå ç”¨æ›´å¤š CPU èµ„æºï¼Œå¹¶å’Œç”¨æˆ·çº¿ç¨‹äº‰æŠ¢ã€‚

* Parrallel GCï¼Œåœ¨æ—©æœŸ JDK 8 ç­‰ç‰ˆæœ¬ä¸­ï¼Œå®ƒæ˜¯ server æ¨¡å¼ JVM çš„é»˜è®¤ GC é€‰æ‹©ï¼Œä¹Ÿè¢«ç§°ä½œæ˜¯ååé‡ä¼˜å…ˆçš„ GCã€‚å®ƒçš„ç®—æ³•å’Œ Serial GC æ¯”è¾ƒç›¸ä¼¼ï¼Œå°½ç®¡å®ç°è¦å¤æ‚çš„å¤šï¼Œå…¶ç‰¹ç‚¹æ˜¯æ–°ç”Ÿä»£å’Œè€å¹´ä»£ GC éƒ½æ˜¯å¹¶è¡Œè¿›è¡Œçš„ï¼Œåœ¨å¸¸è§çš„æœåŠ¡å™¨ç¯å¢ƒä¸­æ›´åŠ é«˜æ•ˆã€‚

```
-XX:+UseParallelGC

// Parallel GC å¼•å…¥äº†å¼€å‘è€…å‹å¥½çš„é…ç½®é¡¹ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥è®¾ç½®æš‚åœæ—¶é—´æˆ–ååé‡ç­‰ç›®æ ‡
-XX:MaxGCPauseMillis=value
-XX:GCTimeRatio=N // GC æ—¶é—´å’Œç”¨æˆ·æ—¶é—´æ¯”ä¾‹ = 1 / (N+1)
```
* G1 GC è¿™æ˜¯ä¸€ç§å…¼é¡¾ååé‡å’Œåœé¡¿æ—¶é—´çš„ GC å®ç°ï¼Œæ˜¯ Oracle JDK 9 ä»¥åçš„é»˜è®¤ GC é€‰é¡¹ã€‚G1 å¯ä»¥ç›´è§‚çš„è®¾å®šåœé¡¿æ—¶é—´çš„ç›®æ ‡ï¼Œç›¸æ¯”äº CMS GCï¼ŒG1 æœªå¿…èƒ½åšåˆ° CMS åœ¨æœ€å¥½æƒ…å†µä¸‹çš„å»¶æ—¶åœé¡¿ï¼Œä½†æ˜¯æœ€å·®æƒ…å†µè¦å¥½å¾ˆå¤šã€‚G1 GC ä»ç„¶å­˜åœ¨ç€å¹´ä»£çš„æ¦‚å¿µï¼Œä½†æ˜¯å…¶å†…å­˜ç»“æ„å¹¶ä¸æ˜¯ç®€å•çš„æ¡å¸¦å¼åˆ’åˆ†ï¼Œè€Œæ˜¯ç±»ä¼¼æ£‹ç›˜çš„ä¸€ä¸ªä¸ª regionã€‚Region ä¹‹é—´æ˜¯å¤åˆ¶ç®—æ³•ï¼Œä½†æ•´ä½“ä¸Šå®é™…å¯çœ‹ä½œæ˜¯æ ‡è®° - æ•´ç†ï¼ˆMark-Compactï¼‰ç®—æ³•ï¼Œå¯ä»¥æœ‰æ•ˆåœ°é¿å…å†…å­˜ç¢ç‰‡ï¼Œå°¤å…¶æ˜¯å½“ Java å †éå¸¸å¤§çš„æ—¶å€™ï¼ŒG1 çš„ä¼˜åŠ¿æ›´åŠ æ˜æ˜¾ã€‚

è¡ç”Ÿçš„é¢è¯•é—®é¢˜:

* åƒåœ¾æ”¶é›†çš„ç®—æ³•æœ‰å“ªäº›ï¼Ÿå¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦å¯ä»¥å›æ”¶ï¼Ÿ
* åƒåœ¾æ”¶é›†å™¨å·¥ä½œçš„åŸºæœ¬æµç¨‹ã€‚

## å¤§çº² - æ€ç»´å¯¼å›¾

![è™šæ‹Ÿæœºæ€§èƒ½ç›‘æ§ä¸æ•…éšœå¤„ç†å·¥å…·](https://ws1.sinaimg.cn/large/006tKfTcly1g0qehb93l9j30u016uwr4.jpg)

## æ¦‚è¿°

å‰é¢ä¸¤ç¯‡æ–‡ç« å¯¹äºã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹çš„è™šæ‹Ÿæœºå†…å­˜åˆ†é…ä¸å›æ”¶æŠ€æœ¯ä¸¤ç« ï¼Œåˆ†åˆ«åšäº†æ€»ç»“è®°å½•ï¼Œå·²ç»å»ºç«‹äº†ä¸€å¥—æ¯”è¾ƒå®Œæ•´çš„ç†è®ºåŸºç¡€ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ä»å®è·µçš„è§’åº¦å»äº†è§£è™šæ‹Ÿæœºå†…å­˜ç®¡ç†ï¼Œå®šä½é—®é¢˜çš„æ—¶å€™ï¼ŒçŸ¥è¯†ã€ç»éªŒæ˜¯å…³é”®åŸºç¡€ï¼Œæ•°æ®æ˜¯ä¾æ®ï¼Œå·¥å…·æ˜¯è¿ç”¨çŸ¥è¯†å¤„ç†æ•°æ®çš„æ‰‹æ®µã€‚

æ•°æ®ä¸»è¦åŒ…æ‹¬:

* è¿è¡Œæ—¥å¿—
* å¼‚å¸¸å †æ ˆ
* GCæ—¥å¿—
* çº¿ç¨‹å¿«ç…§(thread dump / javacoreæ–‡ä»¶)
* å †è½¬å‚¨å¿«ç…§(heapdump/hprofæ–‡ä»¶)ç­‰

## JDKå‘½ä»¤è¡Œå·¥å…·

Javaå®‰è£…ç›®å½• binç›®å½•ä¸‹æœ‰å¾ˆå¤šå®˜æ–¹æä¾›çš„å‘½ä»¤è¡Œç¨‹åºï¼Œä»Šå¤©æˆ‘ä»¬ä¿©äº†è§£ä¸‹è™šæ‹Ÿæœºæ€§èƒ½ç›‘æ§ä¸æ•…éšœå¤„ç†å·¥å…·

| åç§° | ä¸»è¦ä½œç”¨ |
| --- | --- |
| jps | JVM Process Status Tool, æ˜¾ç¤ºæŒ‡å®šç³»ç»Ÿå†…æ‰€æœ‰çš„HotSpotçš„è™šæ‹Ÿæœºè¿›ç¨‹ |
| jstat | JVM Statistics Monitoring Toolï¼Œç”¨äºæ”¶é›†HotSpotå„æ–¹é¢çš„è¿è¡Œæ•°æ® |
| jinfo | Configuration Info for Javaï¼Œæ˜¾ç¤ºè™šæ‹Ÿæœºçš„é…ç½®ä¿¡æ¯ |
| jmap | Memory Map for Javaï¼Œç”ŸæˆJavaå†…å­˜è½¬å‚¨å¿«ç…§(dumpæ–‡ä»¶) |
| jhat | JVM Heap Dump Browserï¼Œç”¨äºåˆ†ædumpæ–‡ä»¶ï¼Œä¼šåˆ›å»ºHTTP/HTMLæœåŠ¡å™¨ï¼Œå¯ä»¥åœ¨æµè§ˆå™¨ä¸Šæµè§ˆ |
| jstack | Stack Trace for Javaï¼Œæ˜¾ç¤ºè™šæ‹Ÿæœºçš„çº¿ç¨‹å¿«ç…§ |

#### jps: è™šæ‹Ÿæœºè¿›ç¨‹çŠ¶å†µå·¥å…·

ä¸ä»…åå­—åƒlunixä¸»æœºçš„pså‘½ä»¤ï¼ŒåŠŸèƒ½ä¹Ÿç›¸ä¼¼ï¼ŒJDKä¸­çš„jpså‘½ä»¤([å¸®åŠ©æ–‡æ¡£](https://docs.oracle.com/en/java/javase/11/tools/jps.html#GUID-6EB65B96-F9DD-4356-B825-6146E9EEC81E))å¯ä»¥åˆ—ä¸¾å‡ºæ­£åœ¨è¿è¡Œçš„è™šæ‹Ÿæœºè¿›ç¨‹ï¼Œå¹¶æ˜¾ç¤ºè™šæ‹Ÿæœºæ‰§è¡Œä¸»ç±»ï¼ˆMain Class,mainå‡½æ•°æ‰€åœ¨çš„ç±»ï¼‰åç§°ä»¥åŠè¿™äº›è¿›ç¨‹çš„æœ¬åœ°è™šæ‹Ÿæœºå”¯ä¸€IDï¼ˆLocal Virtual Machine Identifier ï¼ŒLVMIDï¼‰ã€‚

ä½¿ç”¨é¢‘ç‡æœ€é«˜çš„JDKå‘½ä»¤è¡Œå·¥å…·ï¼Œä»¥ä¸ºå†…å…¶ä»–çš„JDKå·¥å…·å¤§å¤šéœ€è¦è¾“å…¥å®ƒæŸ¥è¯¢åˆ°LVMIDæ¥ç¡®å®šè¦ç›‘æ§çš„æ˜¯å“ªä¸€ä¸ªè™šæ‹Ÿæœºè¿›ç¨‹ã€‚ å¯¹äºæœ¬åœ°è™šæ‹Ÿæœºè¿›ç¨‹æ¥è®²ï¼ŒLVMIDå’Œæ“ä½œç³»ç»Ÿçš„è¿›ç¨‹ID(Process Identifer ,PID) ä¸€è‡´ã€‚

è¯­æ³•:

```
usage: jps [-help]
       jps [-q] [-mlvV] [<hostid>]

Definitions:
    <hostid>:      <hostname>[:<port>]
```

![](https://ws1.sinaimg.cn/large/006tKfTcly1g0qei14sopj30so068dhg.jpg)

åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œjpsçš„è¾“å‡ºä¿¡æ¯åŒ…æ‹¬ Java è¿›ç¨‹çš„è¿›ç¨‹ ID ä»¥åŠä¸»ç±»åã€‚æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡è¿½åŠ å‚æ•°ï¼Œæ¥æ‰“å°é¢å¤–çš„ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œ-lå°†æ‰“å°æ¨¡å—åä»¥åŠåŒ…åï¼›-vå°†æ‰“å°ä¼ é€’ç»™ Java è™šæ‹Ÿæœºçš„å‚æ•°ï¼ˆå¦‚-XX:+UnlockExperimentalVMOptions -XX:+UseZGCï¼‰ï¼›-må°†æ‰“å°ä¼ é€’ç»™ä¸»ç±»çš„å‚æ•°ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæŸ Java è¿›ç¨‹å…³é—­äº†é»˜è®¤å¼€å¯çš„UsePerfDataå‚æ•°ï¼ˆå³ä½¿ç”¨å‚æ•°-XX:-UsePerfDataï¼‰ï¼Œé‚£ä¹ˆjpså‘½ä»¤ï¼ˆä»¥åŠä¸‹é¢ä»‹ç»çš„jstatï¼‰å°†æ— æ³•æ¢çŸ¥è¯¥ Java è¿›ç¨‹ã€‚

å½“è·å¾— Java è¿›ç¨‹çš„è¿›ç¨‹ ID ä¹‹åï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥è°ƒç”¨æ¥ä¸‹æ¥ä»‹ç»çš„å„é¡¹ç›‘æ§åŠè¯Šæ–­å·¥å…·äº†ã€‚

#### jstat: è™šæ‹Ÿæœºç»Ÿè®¡å·¥å…·ç›‘è§†å·¥å…·

jstat (JVM Statistics Monitoring Tool)([å¸®åŠ©æ–‡æ¡£](https://docs.oracle.com/javase/8/docs/technotes/tools/unix/jstat.html#BEHHGFAE))ç”¨äºç›‘è§†è™šæ‹Ÿæœºå„ç§è¿è¡ŒçŠ¶æ€ä¿¡æ¯çš„å‘½ä»¤è¡Œå·¥å…·ã€‚ å®ƒå¯ä»¥æ˜¾ç¤ºæœ¬åœ°æˆ–è€…è¿œç¨‹è™šæ‹Ÿæœºè¿›ç¨‹ä¸­çš„ç±»è£…è½½ã€å†…å­˜ã€åƒåœ¾ä¼šæœã€JITç¼–è¯‘ç­‰è¿è¡Œæ•°æ®ã€‚

åœ¨æ²¡æœ‰å›¾å½¢åŒ–ç•Œé¢çš„æœåŠ¡å™¨ä¸Šï¼Œå®ƒå°†æ˜¯è¿è¡ŒæœŸå®šä½è™šæ‹Ÿæœºæ€§èƒ½é—®é¢˜çš„é¦–é€‰å·¥å…·ã€‚

jstat å‘½ä»¤æ ¼å¼ä¸º:

```
Usage: jstat -help|-options
       jstat -<option> [-t] [-h<lines>] <vmid> [<interval> [<count>]]
       
Definitions:
  <option>      An option reported by the -options option
  <vmid>        Virtual Machine Identifier. A vmid takes the following form:
                     <lvmid>[@<hostname>[:<port>]]
                Where <lvmid> is the local vm identifier for the target
                Java virtual machine, typically a process id; <hostname> is
                the name of the host running the target Java virtual machine;
                and <port> is the port number for the rmiregistry on the
                target host. See the jvmstat documentation for a more complete
                description of the Virtual Machine Identifier.
  <lines>       Number of samples between header lines.
  <interval>    Sampling interval. The following forms are allowed:
                    <n>["ms"|"s"]
                Where <n> is an integer and the suffix specifies the units as
                milliseconds("ms") or seconds("s"). The default units are "ms".
  <count>       Number of samples to take before terminating.
  -J<flag>      Pass <flag> directly to the runtime system.
```

å‡ ç‚¹è¯´æ˜:

* å¯¹äºå‘½ä»¤æ ¼å¼ä¸­çš„VMIDå’ŒLVMIDï¼Œå¦‚æœæ˜¯æœ¬åœ°è™šæ‹Ÿæœºè¿›ç¨‹ï¼Œä¸¤è€…ä¸€è‡´ã€‚å¦‚æœæ˜¯è¿œç¨‹è™šæ‹Ÿæœºè¿›ç¨‹ï¼Œåˆ™VMIDçš„æ ¼å¼ä¸º `[protocol:][//]lvmind[@hostname[:port]/servername]`
* interval : æŸ¥è¯¢é—´éš”
* countï¼šæŸ¥è¯¢æ¬¡æ•° å¦‚æœçœç•¥intervalå’Œcountï¼Œåˆ™åªæŸ¥è¯¢ä¸€æ¬¡

å‡è®¾éœ€è¦250æ¯«ç§’æŸ¥è¯¢ä¸€æ¬¡è¿›ç¨‹3245çš„åƒåœ¾æ”¶é›†çŠ¶å†µï¼Œä¸€å…±æŸ¥è¯¢20æ¬¡

```
jstat -gc 3245 250 20
```

jstatçš„ä¸»è¦é€‰é¡¹:

![](https://ws2.sinaimg.cn/large/006tKfTcly1g0qeihxlivj30su0eaaf5.jpg)

ä¸¾ä¾‹è¯´æ˜:

```
[dashu@*** ~]$ sudo jstat -gcutil 26096 1000 10
  S0     S1     E      O      M     CCS    YGC     YGCT    FGC    FGCT     GCT   
  0.00  48.00  17.05   7.22  94.77  91.65    515    8.555     3    0.652    9.207
  0.00  48.00  17.69   7.22  94.77  91.65    515    8.555     3    0.652    9.207
  0.00  48.00  18.84   7.22  94.77  91.65    515    8.555     3    0.652    9.207
  0.00  48.00  19.99   7.22  94.77  91.65    515    8.555     3    0.652    9.207
  0.00  48.00  20.59   7.22  94.77  91.65    515    8.555     3    0.652    9.207
  0.00  48.00  21.20   7.22  94.77  91.65    515    8.555     3    0.652    9.207
  0.00  48.00  21.84   7.22  94.77  91.65    515    8.555     3    0.652    9.207
  0.00  48.00  23.10   7.22  94.77  91.65    515    8.555     3    0.652    9.207
  0.00  48.00  25.04   7.22  94.77  91.65    515    8.555     3    0.652    9.207
  0.00  48.00  27.28   7.22  94.77  91.65    515    8.555     3    0.652    9.207
```

* S0: Survivor0æ˜¯ç©ºçš„
* S1:Survivor1ä½¿ç”¨äº†48%çš„ç©ºé—´
* Eï¼šEden ä½¿ç”¨äº† 17.05%çš„ç©ºé—´
* O: è€å¹´ä»£ä½¿ç”¨äº† 7.22%çš„ç©ºé—´
* Mï¼š æ°¸ä¹…ä»£?
* CCS: ?
* YGC: Minor GCè¡¨ç¤ºç¨‹åºå¯åŠ¨ä»¥æ¥ï¼Œå‘ç”Ÿäº†515æ¬¡Minor GC
* YGCTï¼šYoung GC Time è€—æ—¶ä¸º8.555ç§’
* FGCï¼šFull GC è¡¨ç¤ºç¨‹åºå¯åŠ¨ä»¥æ¥ï¼Œå‘ç”Ÿäº†3æ¬¡Minor GC
* FGCTï¼šFull GC Time è€—æ—¶ä¸º0.652ç§’
* GCTï¼šè¡¨ç¤ºGC Time ï¼Œæ‰€æœ‰çš„GCæ€»è€—æ—¶ 8.555ç§’

ä½¿ç”¨jstatå·¥å…·åœ¨çº¯æ–‡æœ¬çŠ¶æ€ä¸‹ç›‘è§†è™šæ‹ŸæœºçŠ¶æ€çš„å˜åŒ–ï¼Œç¡®å®ä¸å¦‚åé¢å°†ä¼šæåˆ°çš„VisualVMç­‰å¯è§†åŒ–çš„ç›‘è§†å·¥å…·ç›´æ¥ä»¥å›¾è¡¨å±•ç°é‚£æ ·ç›´è§‚ã€‚ä½†è®¸å¤šæœåŠ¡å™¨ç®¡ç†å‘˜éƒ½ä¹ æƒ¯äº†åœ¨æ–‡æœ¬æ§åˆ¶å°ä¸­å·¥ä½œï¼Œç›´æ¥åœ¨æ§åˆ¶å°ä¸­ä½¿ç”¨jstatå‘½ä»¤ä¾ç„¶æ˜¯ä¸€ç§å¸¸ç”¨çš„ç›‘æ§æ–¹å¼ã€‚

#### jinfo: Javaé…ç½®ä¿¡æ¯å·¥å…·

jinfoï¼ˆConfiguration Info for Javaï¼‰([å¸®åŠ©æ–‡æ¡£](https://docs.oracle.com/javase/8/docs/technotes/tools/unix/jinfo.html#BCGEBFDD))çš„ä½œç”¨æ˜¯å®æ—¶åœ°æŸ¥çœ‹å’Œè°ƒæ•´è™šæ‹Ÿæœºå„é¡¹å‚æ•°ã€‚

å‘½ä»¤è¯­æ³•æ ¼å¼ä¸º:

```
Usage:
    jinfo [option] <pid>
        (to connect to running process)
    jinfo [option] <executable <core>
        (to connect to a core file)
    jinfo [option] [server_id@]<remote server IP or hostname>
        (to connect to remote debug server)

where <option> is one of:
    -flag <name>         to print the value of the named VM flag
    -flag [+|-]<name>    to enable or disable the named VM flag
    -flag <name>=<value> to set the named VM flag to the given value
    -flags               to print VM flags
    -sysprops            to print Java system properties
    <no option>          to print both of the above
    -h | -help           to print this help message
```

ä½¿ç”¨ä¸¾ä¾‹:

```
[root@*** ~]# jinfo -flag MaxPermSize 5653
-XX:MaxPermSize=85983232
```

#### jmap: Javaå†…å­˜æ˜ å°„å·¥å…·

jmapï¼ˆMemory Map for Javaï¼‰([å¸®åŠ©æ–‡æ¡£](https://docs.oracle.com/javase/8/docs/technotes/tools/unix/jmap.html#CEGCECJB))å‘½ä»¤ç”¨äºç”Ÿæˆå †è½¬å‚¨å¿«ç…§ï¼ˆä¸€èˆ¬ç§°ä¸ºheapdumpæˆ–dumpæ–‡ä»¶ï¼‰ã€‚å¦‚æœä¸ä½¿ç”¨jmapå‘½ä»¤ï¼Œè¦æƒ³è·å–Javaå †è½¬å‚¨å¿«ç…§ï¼Œè¿˜æœ‰ä¸€äº›æ¯”è¾ƒâ€œæš´åŠ›â€çš„æ‰‹æ®µï¼šè­¬å¦‚åœ¨ç¬¬2ç« ä¸­ç”¨è¿‡çš„-XXï¼š+HeapDumpOnOutOfMemoryErrorå‚æ•°ï¼Œå¯ä»¥è®©è™šæ‹Ÿæœºåœ¨OOMå¼‚å¸¸å‡ºç°ä¹‹åè‡ªåŠ¨ç”Ÿæˆdumpæ–‡ä»¶ï¼Œé€šè¿‡-XXï¼š+HeapDumpOnCtrlBreakå‚æ•°åˆ™å¯ä»¥ä½¿ç”¨[Ctrl]+[Break]é”®è®©è™šæ‹Ÿæœºç”Ÿæˆdumpæ–‡ä»¶ï¼Œåˆæˆ–è€…åœ¨Linuxç³»ç»Ÿä¸‹é€šè¿‡Kill-3å‘½ä»¤å‘é€è¿›ç¨‹é€€å‡ºä¿¡å·â€œå“å”¬â€ä¸€ä¸‹è™šæ‹Ÿæœºï¼Œä¹Ÿèƒ½æ‹¿åˆ°dumpæ–‡ä»¶ã€‚

å‘½ä»¤è¯­æ³•æ ¼å¼ä¸º:

```
Usage:
    jmap [option] <pid>
        (to connect to running process)
    jmap [option] <executable <core>
        (to connect to a core file)
    jmap [option] [server_id@]<remote server IP or hostname>
        (to connect to remote debug server)

where <option> is one of:
    <none>               to print same info as Solaris pmap
    -heap                to print java heap summary
    -histo[:live]        to print histogram of java object heap; if the "live"
                         suboption is specified, only count live objects
    -clstats             to print class loader statistics
    -finalizerinfo       to print information on objects awaiting finalization
    -dump:<dump-options> to dump java heap in hprof binary format
                         dump-options:
                           live         dump only live objects; if not specified,
                                        all objects in the heap are dumped.
                           format=b     binary format
                           file=<file>  dump heap to <file>
                         Example: jmap -dump:live,format=b,file=heap.bin <pid>
    -F                   force. Use with -dump:<dump-options> <pid> or -histo
                         to force a heap dump or histogram when <pid> does not
                         respond. The "live" suboption is not supported
                         in this mode.
    -h | -help           to print this help message
    -J<flag>             to pass <flag> directly to the runtime system
```

jmapçš„ä¸»è¦é€‰é¡¹:

![](https://ws4.sinaimg.cn/large/006tKfTcly1g0qeivyyusj30sq0c6426.jpg)

ä½¿ç”¨ä¸¾ä¾‹ï¼Œå¯¹pid=19935çš„è¿›ç¨‹è¾“å‡ºdumpä¿¡æ¯:

```
[root@*** ~]# jmap -dump:format=b,file=test.bin 19935
Dumping heap to /root/test.bin ...
Heap dump file created
```

#### jhat: è™šæ‹Ÿæœºå †è½¬å‚¨å¿«ç…§åˆ†æå·¥å…·

Sun JDKæä¾›jhatï¼ˆJVM Heap Analysis Toolï¼‰([å¸®åŠ©æ–‡æ¡£](https://docs.oracle.com/javase/8/docs/technotes/tools/unix/jhat.html#CIHHJAGE))å‘½ä»¤ä¸jmapæ­é…ä½¿ç”¨ï¼Œæ¥åˆ†æjmapç”Ÿæˆçš„å †è½¬å‚¨å¿«ç…§ã€‚jhatå†…ç½®äº†ä¸€ä¸ªå¾®å‹çš„HTTP/HTMLæœåŠ¡å™¨ï¼Œç”Ÿæˆdumpæ–‡ä»¶çš„åˆ†æç»“æœåï¼Œå¯ä»¥åœ¨æµè§ˆå™¨ä¸­æŸ¥çœ‹ã€‚

å‘½ä»¤è¯­æ³•æ ¼å¼:

```
Usage:  jhat [-stack <bool>] [-refs <bool>] [-port <port>] [-baseline <file>] [-debug <int>] [-version] [-h|-help] <file>

       	-J<flag>          Pass <flag> directly to the runtime system. For
       			  example, -J-mx512m to use a maximum heap size of 512MB
       	-stack false:     Turn off tracking object allocation call stack.
       	-refs false:      Turn off tracking of references to objects
       	-port <port>:     Set the port for the HTTP server.  Defaults to 7000
       	-exclude <file>:  Specify a file that lists data members that should
       			  be excluded from the reachableFrom query.
       	-baseline <file>: Specify a baseline object dump.  Objects in
       			  both heap dumps with the same ID and same class will
       			  be marked as not being "new".
       	-debug <int>:     Set debug level.
       			    0:  No debug output
       			    1:  Debug hprof file parsing
       			    2:  Debug hprof file parsing, no server
       	-version          Report version number
       	-h|-help          Print this help and exit
       	<file>            The file to read

For a dump file that contains multiple heap dumps,
you may specify which dump in the file
by appending "#<number>" to the file name, i.e. "foo.hprof#3".

All boolean options default to "true"
```

ä¸¾ä¾‹ä½¿ç”¨:

 - step 1. å‘½ä»¤æ“ä½œ

```
Lin@****:~/tmp|â‡’  jmap -dump:format=b,file=test.bin 99022
Dumping heap to /Users/Lin/tmp/test.bin ...
Heap dump file created
Lin@****:~/tmp|â‡’  jhat test.bin
Reading from test.bin...
Dump file created Wed Feb 20 07:56:38 CST 2019
Snapshot read, resolving...
Resolving 21672 objects...
Chasing references, expect 4 dots....
Eliminating duplicate references....
Snapshot resolved.
Started HTTP server on port 7000
Server is ready.
```

 - æµè§ˆå™¨æ‰“å¼€ http://localhost:7000/

![](https://ws1.sinaimg.cn/large/006tKfTcly1g0qejall6yj31di0suds2.jpg)

#### jstack: Javaå †æ ˆè·Ÿè¸ªå·¥å…·

jstackï¼ˆStack Trace for Javaï¼‰([å¸®åŠ©æ–‡æ¡£](https://docs.oracle.com/javase/8/docs/technotes/tools/unix/jstack.html#BABGJDIF))å‘½ä»¤ç”¨äºç”Ÿæˆè™šæ‹Ÿæœºå½“å‰æ—¶åˆ»çš„çº¿ç¨‹å¿«ç…§ï¼ˆä¸€èˆ¬ç§°ä¸ºthreaddumpæˆ–è€…javacoreæ–‡ä»¶ï¼‰ã€‚çº¿ç¨‹å¿«ç…§å°±æ˜¯å½“å‰è™šæ‹Ÿæœºå†…æ¯ä¸€æ¡çº¿ç¨‹æ­£åœ¨æ‰§è¡Œçš„æ–¹æ³•å †æ ˆçš„é›†åˆï¼Œç”Ÿæˆçº¿ç¨‹å¿«ç…§çš„ä¸»è¦ç›®çš„æ˜¯å®šä½çº¿ç¨‹å‡ºç°é•¿æ—¶é—´åœé¡¿çš„åŸå› ï¼Œå¦‚çº¿ç¨‹é—´æ­»é”ã€æ­»å¾ªç¯ã€è¯·æ±‚å¤–éƒ¨èµ„æºå¯¼è‡´çš„é•¿æ—¶é—´ç­‰å¾…ç­‰éƒ½æ˜¯å¯¼è‡´çº¿ç¨‹é•¿æ—¶é—´åœé¡¿çš„å¸¸è§åŸå› ã€‚çº¿ç¨‹å‡ºç°åœé¡¿çš„æ—¶å€™é€šè¿‡jstackæ¥æŸ¥çœ‹å„ä¸ªçº¿ç¨‹çš„è°ƒç”¨å †æ ˆï¼Œå°±å¯ä»¥çŸ¥é“æ²¡æœ‰å“åº”çš„çº¿ç¨‹åˆ°åº•åœ¨åå°åšäº›ä»€ä¹ˆäº‹æƒ…ï¼Œæˆ–è€…ç­‰å¾…ç€ä»€ä¹ˆèµ„æºã€‚

å‘½ä»¤è¯­æ³•æ ¼å¼:

```
Usage:
    jstack [-l] <pid>
        (to connect to running process)
    jstack -F [-m] [-l] <pid>
        (to connect to a hung process)
    jstack [-m] [-l] <executable> <core>
        (to connect to a core file)
    jstack [-m] [-l] [server_id@]<remote server IP or hostname>
        (to connect to a remote debug server)

Options:
    -F  to force a thread dump. Use when jstack <pid> does not respond (process is hung)
    -m  to print both java and native frames (mixed mode)
    -l  long listing. Prints additional information about locks
    -h or -help to print this help message
```

jstackçš„ä¸»è¦é€‰é¡¹:

![](https://ws4.sinaimg.cn/large/006tKfTcly1g0qejmubvcj30sg05edh5.jpg)

ä¸¾ä¾‹ä½¿ç”¨:

```
Lin@***:~/tmp|â‡’  jstack -l 99022
2019-02-20 08:02:55
Full thread dump Java HotSpot(TM) 64-Bit Server VM (25.74-b02 mixed mode):

"Attach Listener" #10 daemon prio=9 os_prio=31 tid=0x00007fb2aa872000 nid=0xe07 waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

   Locked ownable synchronizers:
       	- None

"Monitor Ctrl-Break" #9 daemon prio=5 os_prio=31 tid=0x00007fb2aa86f800 nid=0x4503 runnable [0x000070000e987000]
   java.lang.Thread.State: RUNNABLE
       	at java.net.PlainSocketImpl.socketAccept(Native Method)
       	at java.net.AbstractPlainSocketImpl.accept(AbstractPlainSocketImpl.java:409)
       	at java.net.ServerSocket.implAccept(ServerSocket.java:545)
       	at java.net.ServerSocket.accept(ServerSocket.java:513)
       	at com.intellij.rt.execution.application.AppMain$1.run(AppMain.java:90)
       	at java.lang.Thread.run(Thread.java:745)

   Locked ownable synchronizers:
       	- None

"Service Thread" #8 daemon prio=9 os_prio=31 tid=0x00007fb2ab013000 nid=0x4703 runnable [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE
   ...
   .....
```

#### HSDIS:JITç”Ÿæˆä»£ç åæ±‡ç¼–

HSDIS æ˜¯ä¸€ä¸ªSunå®˜æ–¹æ¨èçš„HotSpotè™šæ‹ŸæœºJITç¼–è¯‘ä»£ç çš„åæ±‡ç¼–æ’ä»¶ï¼Œå®ƒåŒ…å«åœ¨HotSpotè™šæ‹Ÿæœºçš„æºç ä¹‹ä¸­ï¼Œä½†æ²¡æœ‰æä¾›ç¼–è¯‘åçš„ç¨‹åºã€‚

åœ¨Project Kenaiçš„ç½‘ç«™ä¹Ÿå¯ä»¥ä¸‹è½½åˆ°å•ç‹¬çš„æºç ã€‚å®ƒçš„ä½œç”¨æ˜¯è®©HotSpotçš„-XX:+PrintAssembly æŒ‡ä»¤è°ƒç”¨å®ƒæ¥æŠŠåŠ¨æ€ç”Ÿæˆçš„æœ¬åœ°ä»£ç è¿˜åŸä¸ºæ±‡ç¼–ä»£ç è¾“å‡ºï¼ŒåŒæ—¶è¿˜ç”Ÿæˆäº†å¤§é‡éå¸¸æœ‰ä»·å€¼çš„æ³¨é‡Šï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è¾“å‡ºçš„ä»£ç æ¥åˆ†æé—®é¢˜ã€‚

## JDKçš„å¯è§†åŒ–å·¥å…·

JDKä¸­é™¤äº†æä¾›å¤§é‡çš„å‘½ä»¤è¡Œå·¥å…·å¤–ï¼Œè¿˜æœ‰ä¸¤ä¸ªåŠŸèƒ½å¼ºå¤§çš„å¯è§†åŒ–å·¥å…·ï¼šJConsoleå’ŒVisualVMï¼Œè¿™ä¸¤ä¸ªå·¥å…·æ˜¯JDKçš„æ­£å¼æˆå‘˜ï¼Œæ²¡æœ‰è¢«è´´ä¸Šâ€œunsupported and experimentalâ€çš„æ ‡ç­¾ã€‚

ä¸Šè¿°å…¨é¢è®²è¿°äº†JDKå‘½ä»¤è¡Œå·¥å…·ï¼Œå¯ä»¥æ–¹ä¾¿åœ°åœ¨æœåŠ¡å™¨ä¸Šç›´æ¥åˆ†æJVMçš„çŠ¶æ€ï¼Œä¸è¿‡å®è¯è¯´ï¼Œåœ¨å®é™…å·¥ä½œä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨å¯è§†åŒ–å·¥å…·æ¥æŸ¥è¯¢ã€åˆ†æJVMæƒ…å†µï¼Œå°¤å…¶å¯¹äºä¸å¤ªä¼šç›´æ¥ä½¿ç”¨jhatè¿™ç±»çš„JVMå †æ ˆå¿«ç…§åˆ†æï¼Œé™¤éæ‰‹ä¸ŠçœŸçš„æ²¡æœ‰åˆ«çš„å·¥å…·å¯ç”¨ï¼Œä¸€æ˜¯å› ä¸ºåˆ†æå·¥ä½œæ˜¯ä¸€ä¸ªè€—æ—¶è€Œä¸”æ¶ˆè€—èµ„æºçš„äº‹æƒ…ï¼Œæ—¢ç„¶æœ‰å¯è§†åŒ–å·¥å…·ï¼Œå°±æ²¡å¿…è¦å—åˆ°å‘½ä»¤è¡Œå·¥å…·çš„é™åˆ¶äº†ï¼›äºŒæ˜¯å‘½ä»¤è¡Œå·¥å…·çš„åˆ†ææ¯”è¾ƒç®€é™‹ã€ä¸ç›´è§‚ï¼Œåé¢ä»‹ç»çš„VisualVMï¼Œä»¥åŠä¸“ä¸šç”¨äºåˆ†ædumpæ–‡ä»¶çš„Eclipse Memory Analyzerã€IBM HeapAnalyzerç­‰å·¥å…·æœ‰æ›´å¼ºå¤§æ›´ä¸“ä¸šçš„åˆ†æåŠŸèƒ½ã€‚

#### JConsoleï¼šJavaç›‘è§†ä¸ç®¡ç†æ§åˆ¶å°

ä»Java 5å¼€å§‹ å¼•å…¥äº† JConsoleï¼ŒJConsole æ˜¯ä¸€ä¸ªå†…ç½® Java æ€§èƒ½åˆ†æå™¨ã€‚æ‚¨å¯ä»¥è½»æ¾åœ°ä½¿ç”¨ JConsoleï¼ˆæˆ–è€…ï¼Œå®ƒæ›´é«˜ç«¯çš„ â€œè¿‘äº²â€ jvisualvm ï¼‰æ¥ç›‘æ§ Java åº”ç”¨ç¨‹åºæ€§èƒ½å’Œè·Ÿè¸ª Java ä¸­çš„ä»£ç ã€‚ï¼ˆæ¨èä½¿ç”¨å‡çº§ç‰ˆ JConsole å³ jvisualvm ã€‚ï¼‰

å¯åŠ¨ç¨‹åº:

![](https://ws3.sinaimg.cn/large/006tKfTcly1g0qejze6u2j30gq03o3z5.jpg)

å…ˆçœ‹ä¸€ä¸‹å·¥å…·çš„ç•Œé¢:

![](https://ws2.sinaimg.cn/large/006tKfTcly1g0qeke5b75j31000u0gv4.jpg)

JConsoleä¸»ç•Œé¢ï¼Œå¯ä»¥çœ‹åˆ°ä¸»ç•Œé¢é‡Œå…±åŒ…æ‹¬â€œæ¦‚è¿°â€ã€â€œå†…å­˜â€ã€â€œçº¿ç¨‹â€ã€â€œç±»â€ã€â€œVMæ‘˜è¦â€ã€â€œMBeanâ€6ä¸ªé¡µç­¾

æ¥ä¸‹æ¥ï¼Œç¬”è€…åˆ›å»ºä¸€ä¸ªã€ŒMonitorTestã€åé¢æ•™æä»£ç ï¼Œæ¥ä¸€ä¸€ä»‹ç»JConsoleçš„å‡ ä¸ªtabé¡µã€‚

* å†…å­˜ç›‘æ§

ä»£ç æ¸…å•:

```java
/**
 * -Xms100m -Xmx100m -XXï¼š+UseSerialGC
 * ä»¥64KB/50æ¯«ç§’çš„é€Ÿåº¦å¾€Javaå †ä¸­å¡«å……æ•°æ®ï¼Œä¸€å…±å¡«å……1000æ¬¡
 * Created by Lin on 2019/2/21.
 */
public class MonitorTest {

    /**
     * å†…å­˜å ä½ç¬¦å¯¹è±¡, ä¸€ä¸ªOOMObjectå¤§çº¦å 64KB
     */
    static class OOMObject {
        public byte[] placeholder = new byte[64 * 1024];
    }

    public static void fillHeap(int num) throws InterruptedException {
        List<OOMObject> list = new ArrayList<>();

        for (int i=0; i< num; i++) {
            Thread.sleep(50);
            list.add(new OOMObject());
        }
        System.gc();
    }

    public static void main(String[] args) throws Exception{
        fillHeap(1000);
    }

}
```

è§‚å¯Ÿå†…å­˜Tab

å†…å­˜tabç›¸å½“äºå¯è§†åŒ–çš„jstatå‘½ä»¤ï¼Œç”¨äºç›‘è§†æ”¶é›†å™¨ç®¡ç†çš„è™šæ‹Ÿæœºå†…å­˜(Javaå †å’Œæ°¸ä¹…ä»£)çš„å˜åŒ–è¶‹åŠ¿ã€‚æˆ‘ä»¬é€šè¿‡è¿è¡Œä¸Šè¿°ä»£ç æ¥ä½“éªŒä¸€ä¸‹å®ƒçš„ç›‘è§†åŠŸèƒ½: 

![](https://ws1.sinaimg.cn/large/006tKfTcly1g0qekq6kasj312e0u0n5e.jpg)

è¿è¡Œæ—¶è®¾ç½®çš„è™šæ‹Ÿæœºå‚æ•°ä¸º:  -Xms100m -Xmx100m -XX:+UseSerialGCï¼Œä»¥64KM/50æ¯«ç§’çš„é€Ÿåº¦å¾€Javaå †ä¸­å¡«å……æ•°æ®ï¼Œä¸€å…±å¡«å……1000æ¬¡ï¼Œä½¿ç”¨JConsoleçš„ã€Œå†…å­˜ã€tabè¿›è¡Œç›‘è§†ï¼Œè§‚å¯Ÿæ›²çº¿å’ŒæŸ±çŠ¶æŒ‡ç¤ºå›¾çš„å˜åŒ–ã€‚åœ¨ã€Œå†…å­˜ã€tabä¸­å¯ä»¥çœ‹åˆ°å†…å­˜æ± EdenåŒºçš„è¿è¡Œè¶‹åŠ¿å‘ˆç°æŠ˜çº¿çŠ¶ï¼Œå°†ç›‘è§†èŒƒå›´æ‰©å¤§è‡³æ•´ä¸ªå †åï¼Œä¼šå‘ç°æ›²çº¿æ˜¯ä¸€æ¡å‘ä¸Šå¢é•¿çš„å¹³æ»‘æ›²çº¿ï¼Œä»æŸ±çŠ¶å›¾çœ‹ï¼Œ1000æ¬¡å¾ªç¯ç»“æŸï¼Œæ•´ä¸ªæ–°ç”Ÿä»£Edenå’ŒSurvivoråŒºéƒ½åŸºæœ¬è¢«æ¸…ç©ºäº†ï¼Œä½†æ˜¯è€å¹´ä»£ä»ç„¶ä¿æŒå³°å€¼çŠ¶æ€ã€‚ä¸‹é¢ä¸¤ä¸ªå°é—®é¢˜:

* è™šæ‹Ÿæœºå¯åŠ¨å‚æ•°åªé™åˆ¶äº†Javaå †ä¸º100MBï¼Œæ²¡æœ‰æŒ‡å®š-Xmnå‚æ•°ï¼Œèƒ½å¦ä¼°è®¡å‡ºæ–°ç”Ÿä»£æœ‰å¤šå¤§ï¼Ÿ
* ä¸ºä½•æ‰§è¡Œäº†```System.gc();```ä¹‹åï¼Œè€å¹´ä»£çš„æŸ±çŠ¶å›¾ä»ç„¶æ˜¾ç¤ºå³°å€¼çŠ¶æ€ï¼Ÿ

ç­”æ¡ˆ:

* é—®é¢˜1: å›¾ä¸­æ˜¾ç¤ºEdenç©ºé—´ä¸º27328KBï¼Œå› ä¸ºæ²¡æœ‰è®¾ç½®```-XX:SurvivorRadio```å‚æ•°ï¼Œæ‰€ä»¥Edenä¸Survivorç©ºé—´æ¯”ä¾‹é»˜è®¤ä¸º8:1ï¼Œæ•´ä¸ªæ–°ç”Ÿä»£ç©ºé—´å¤§çº¦ä¸º27328KB*125%=34160KBã€‚
* é—®é¢˜2: æ‰§è¡Œå®ŒSystem.gcï¼ˆï¼‰ä¹‹åï¼Œç©ºé—´æœªèƒ½å›æ”¶æ˜¯å› ä¸ºListï¼œOOMObjectï¼listå¯¹è±¡ä»ç„¶å­˜æ´»ï¼ŒfillHeapï¼ˆï¼‰æ–¹æ³•ä»ç„¶æ²¡æœ‰é€€å‡ºï¼Œå› æ­¤listå¯¹è±¡åœ¨System.gcï¼ˆï¼‰æ‰§è¡Œæ—¶ä»ç„¶å¤„äºä½œç”¨åŸŸä¹‹å†…[2]ã€‚å¦‚æœæŠŠSystem.gcï¼ˆï¼‰ç§»åŠ¨åˆ°fillHeapï¼ˆï¼‰æ–¹æ³•å¤–è°ƒç”¨å°±å¯ä»¥å›æ”¶æ‰å…¨éƒ¨å†…å­˜ã€‚

* çº¿ç¨‹ç›‘æ§

ã€Œçº¿ç¨‹ã€tabçš„åŠŸèƒ½ç›¸å½“äºå¯è§†åŒ–çš„jstackå‘½ä»¤ï¼Œé‡åˆ°çº¿ç¨‹åœé¡¿æ—¶å¯ä»¥ä½¿ç”¨è¿™ä¸ªtabè¿›è¡Œç›‘æ§åˆ†æã€‚çº¿ç¨‹é•¿æ—¶é—´åœé¡¿çš„ä¸»è¦åŸå› æœ‰:

* ç­‰å¾…å¤–éƒ¨èµ„æº(æ•°æ®åº“è¿æ¥ã€ç½‘ç»œèµ„æºã€è®¾å¤‡èµ„æºç­‰)
* æ­»å¾ªç¯
* é”
* ...

çº¿ç¨‹ç­‰å¾…çš„æ¼”ç¤ºä»£ç :

```java
    /**
     * çº¿ç¨‹æ­»å¾ªç¯æ¨¡æ‹Ÿ
     */
    public static void createBusyThread() {
        Thread thread = new Thread(new Runnable() {
            @Override
            public void run() {
                while (true){
                    ;
                }
            }
        }, "testBusyThread");
        thread.start();
    }

    public static void createLockThread(final Object lock) {
        Thread thread = new Thread(new Runnable() {
            @Override
            public void run() {
                synchronized (lock) {
                    try {
                        lock.wait();
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }
            }
        }, "testLockThread");
        thread.start();
    }

    public static void main(String[] args) throws Exception{
        Thread.sleep(5000);

        BufferedReader bufferedReader = new BufferedReader(new InputStreamReader(System.in));
        bufferedReader.readLine();
        System.out.println("create busy thread.");
        createBusyThread();
        bufferedReader.readLine();
        System.out.println("create lock thread.");
        createLockThread(new Object());
        bufferedReader.readLine();
    }
```

è¿è¡Œä¸Šè¿°ä»£ç ï¼Œåœ¨ã€Œçº¿ç¨‹ã€tabä¸­é€‰æ‹©mainçº¿ç¨‹ï¼Œå †æ ˆè¿½è¸ªæ˜¾ç¤ºBufferedReaderåœ¨readBytesæ–¹æ³•ä¸­ç­‰å¾…System.inçš„é”®ç›˜è¾“å…¥ï¼Œçº¿ç¨‹çŠ¶æ€æ˜¯RunnableçŠ¶æ€ï¼ŒRunnableçŠ¶æ€çš„çº¿ç¨‹ä¼šè¢«åˆ†é…è¿è¡Œæ—¶é—´ï¼Œä½†readBytesæ–¹æ³•æ£€æŸ¥åˆ°æµæ²¡æœ‰æ›´æ–°æ—¶ä¼šç«‹åˆ»å½’è¿˜æ‰§è¡Œä»¤ç‰Œï¼Œè¿™ç§ç­‰å¾…åªæ¶ˆè€—å¾ˆå°çš„CPUèµ„æºã€‚

![](https://ws3.sinaimg.cn/large/006tKfTcly1g0qel6tovxj31b60h445n.jpg)

æ¥ç€ç›‘è§†testBusyThreadçº¿ç¨‹ï¼ŒtestBusyThreadçº¿ç¨‹ä¸€ç›´åœ¨æ‰§è¡Œç©ºå¾ªç¯ï¼Œä»å †æ ˆè¿½è¸ªä¸­çœ‹åˆ°ä¸€ç›´åœ¨MonitoringTest.javaä»£ç çš„41è¡Œåœç•™ï¼Œ43è¡Œä¸ºï¼šwhileï¼ˆtrueï¼‰ã€‚è¿™æ—¶å€™çº¿ç¨‹ä¸ºRunnableçŠ¶æ€ï¼Œè€Œä¸”æ²¡æœ‰å½’è¿˜çº¿ç¨‹æ‰§è¡Œä»¤ç‰Œçš„åŠ¨ä½œï¼Œä¼šåœ¨ç©ºå¾ªç¯ä¸Šç”¨å°½å…¨éƒ¨æ‰§è¡Œæ—¶é—´ç›´åˆ°çº¿ç¨‹åˆ‡æ¢ï¼Œè¿™ç§ç­‰å¾…ä¼šæ¶ˆè€—è¾ƒå¤šçš„CPUèµ„æºã€‚

![](https://ws1.sinaimg.cn/large/006tKfTcly1g0qeljyxd0j31as0f642a.jpg)

ä¸‹å›¾æ˜¾ç¤ºtestLockThreadçº¿ç¨‹åœ¨ç­‰å¾…ç€lockå¯¹è±¡çš„notifyæˆ–notifyAllæ–¹æ³•çš„å‡ºç°ï¼Œçº¿ç¨‹è¿™æ—¶å€™å¤„äºWAITINGçŠ¶æ€ï¼Œåœ¨è¢«å”¤é†’å‰ä¸ä¼šè¢«åˆ†é…æ‰§è¡Œæ—¶é—´ã€‚

![](https://ws4.sinaimg.cn/large/006tKfTcly1g0qelwdupwj31bg0h0wjo.jpg)

testLockThreadçº¿ç¨‹æ­£åœ¨å¤„äºæ­£å¸¸çš„æ´»é”ç­‰å¾…ï¼Œåªè¦lockå¯¹è±¡çš„notifyï¼ˆï¼‰æˆ–notifyAllï¼ˆï¼‰æ–¹æ³•è¢«è°ƒç”¨ï¼Œè¿™ä¸ªçº¿ç¨‹ä¾¿èƒ½æ¿€æ´»ä»¥ç»§ç»­æ‰§è¡Œã€‚ä¸‹é¢æ¼”ç¤ºä¸€ä¸ªæ— æ³•å†è¢«æ¿€æ´»çš„æ­»é”ç­‰å¾…ã€‚

æ­»é”çš„ä»£ç :

```java
public class SynAddRunnable implements Runnable {

    int a, b;

    SynAddRunnable(int a, int b) {
        this.a = a;
        this.b = b;
    }

    @Override
    public void run() {
        synchronized (Integer.valueOf(a)) {
            synchronized ((Integer.valueOf(b))) {
                System.out.println(a + b);
            }
        }
    }

    public static void main(String[] args) {
        System.out.println("lock thread start");
        for (int i = 0; i < 100; i++) {
            new Thread(new SynAddRunnable(1, 2)).start();
            new Thread(new SynAddRunnable(2, 1)).start();
        }
    }
}
```

è¿™æ®µä»£ç å¼€äº†200ä¸ªçº¿ç¨‹å»åˆ†åˆ«è®¡ç®—1+2ä»¥åŠ2+1çš„å€¼ï¼Œå…¶å®forå¾ªç¯æ˜¯å¯çœç•¥çš„ï¼Œä¸¤ä¸ªçº¿ç¨‹ä¹Ÿå¯èƒ½ä¼šå¯¼è‡´æ­»é”ï¼Œä¸è¿‡é‚£æ ·æ¦‚ç‡å¤ªå°ï¼Œéœ€è¦å°è¯•è¿è¡Œå¾ˆå¤šæ¬¡æ‰èƒ½çœ‹åˆ°æ•ˆæœã€‚ä¸€èˆ¬çš„è¯ï¼Œå¸¦forå¾ªç¯çš„ç‰ˆæœ¬æœ€å¤šè¿è¡Œ2ï½3æ¬¡å°±ä¼šé‡åˆ°çº¿ç¨‹æ­»é”ï¼Œç¨‹åºæ— æ³•ç»“æŸã€‚

å‡ºç°çº¿ç¨‹æ­»é”ä¹‹åï¼Œç‚¹å‡»JConsoleçº¿ç¨‹é¢æ¿çš„â€œæ£€æµ‹åˆ°æ­»é”â€æŒ‰é’®ï¼Œå°†å‡ºç°ä¸€ä¸ªæ–°çš„â€œæ­»é”â€é¡µç­¾ï¼Œå¦‚å›¾:

![](https://ws2.sinaimg.cn/large/006tKfTcly1g0qemefbcuj31aw0icq65.jpg)

å¾ˆæ¸…æ™°åœ°æ˜¾ç¤ºäº†çº¿ç¨‹Thread-35åœ¨ç­‰å¾…ä¸€ä¸ªè¢«çº¿ç¨‹Thread-36æŒæœ‰Integerå¯¹è±¡ï¼Œè€Œç‚¹å‡»çº¿ç¨‹Thread-36åˆ™æ˜¾ç¤ºå®ƒä¹Ÿåœ¨ç­‰å¾…ä¸€ä¸ªIntegerå¯¹è±¡ï¼Œè¢«çº¿ç¨‹Thread-35æŒæœ‰ï¼Œè¿™æ ·ä¸¤ä¸ªçº¿ç¨‹å°±äº’ç›¸å¡ä½ï¼Œéƒ½ä¸å­˜åœ¨ç­‰åˆ°é”é‡Šæ”¾çš„å¸Œæœ›äº†ã€‚

#### 4.3.2ã€€VisualVMï¼šå¤šåˆä¸€æ•…éšœå¤„ç†å·¥å…·

VisualVMï¼ˆAll-in-One Java Troubleshooting Toolï¼‰æ˜¯åˆ°ç›®å‰ä¸ºæ­¢éšJDKå‘å¸ƒçš„åŠŸèƒ½æœ€å¼ºå¤§çš„è¿è¡Œç›‘è§†å’Œæ•…éšœå¤„ç†ç¨‹åºï¼Œå¹¶ä¸”å¯ä»¥é¢„è§åœ¨æœªæ¥ä¸€æ®µæ—¶é—´å†…éƒ½æ˜¯å®˜æ–¹ä¸»åŠ›å‘å±•çš„è™šæ‹Ÿæœºæ•…éšœå¤„ç†å·¥å…·ã€‚

ä¸‹é¢æ¼”ä¹ ä¸‹å¦‚ä½•ä½¿ç”¨VisualVMè¿›è¡ŒJAVAæ€§èƒ½åˆ†æåŠè°ƒä¼˜ã€‚

1. Macç¯å¢ƒå®‰è£…JVisualVM:

å®‰è£…ä¸å¤šè¯´ï¼Œè¯·å‰å¾€[å®˜ç½‘](https://visualvm.github.io/download.html)è‡ªè¡Œä¸‹è½½å®‰è£…ã€‚

2. å¯åŠ¨JVisualVM

ç»ˆç«¯å‘½ä»¤: ```jvisualvm```

![](https://ws4.sinaimg.cn/large/006tKfTcly1g0qemtznvej31df0u0n2q.jpg)


3. æ’ä»¶

é¦–æ¬¡å¯åŠ¨VisualVMåï¼Œè¯»è€…å…ˆä¸å¿…ç€æ€¥æ‰¾åº”ç”¨ç¨‹åºè¿›è¡Œç›‘æµ‹ï¼Œå› ä¸ºç°åœ¨VisualVMè¿˜æ²¡æœ‰åŠ è½½ä»»ä½•æ’ä»¶ï¼Œè™½ç„¶åŸºæœ¬çš„ç›‘è§†ã€çº¿ç¨‹é¢æ¿çš„åŠŸèƒ½ä¸»ç¨‹åºéƒ½ä»¥é»˜è®¤æ’ä»¶çš„å½¢å¼æä¾›äº†ï¼Œä½†æ˜¯ä¸ç»™VisualVMè£…ä»»ä½•æ‰©å±•æ’ä»¶ï¼Œå°±ç›¸å½“äºæ”¾å¼ƒäº†å®ƒæœ€ç²¾åçš„åŠŸèƒ½ï¼Œå’Œæ²¡æœ‰å®‰è£…ä»»ä½•åº”ç”¨è½¯ä»¶æ“ä½œç³»ç»Ÿå·®ä¸å¤šã€‚

ç›®å‰VisualVMå·²ç»ç”± visualvm.java.net è¿ç§»åˆ°äº† visualvm.github.ioï¼Œå› æ­¤å¦‚æœä½ ä½¿ç”¨JDKä¸‹çš„jvisualvmï¼Œå½“ä½ å®‰è£…æ’ä»¶æ—¶ä¼šå¤±è´¥ï¼Œä½ å¯ä»¥Tools -> Plugins -> Settingsæ·»åŠ æœ€æ–°çš„æ’ä»¶ä¸­å¿ƒå¦‚ï¼šhttps://visualvm.github.io/uc/release139/updates.xml.gz

![](https://ws2.sinaimg.cn/large/006tKfTcly1g0qenar8tmj31eo0u0wko.jpg)

å„ç‰ˆæœ¬æœ€æ–°çš„æ’ä»¶ä¸­å¿ƒå¯ä»¥è¿™é‡ŒæŸ¥çœ‹ï¼šhttps://visualvm.github.io/pluginscenters.html

4. JVisualVMä¼šè‡ªåŠ¨æ£€æµ‹æœ¬åœ°çš„javaåº”ç”¨ï¼Œä½¿ç”¨ã€ŒVisual GCã€

é€šè¿‡æ–°å¢æœ€æ–°çš„æ’ä»¶ä¸­å¿ƒåï¼Œä½ å¯ä»¥çœ‹åˆ°ã€Œå¯ç”¨æ’ä»¶ã€ä¸­å¤šäº†Toolsï¼Œå…¶ä¸­æœ‰ã€ŒVisual GCã€ï¼Œæ¨èå®‰è£…ã€‚

ä¸‹é¢æ¥ç›‘æ§ä¹‹å‰çš„ã€ŒMonitorTestã€

![](https://ws3.sinaimg.cn/large/006tKfTcly1g0qenmcpetj319l0u0h4h.jpg)

è°ƒæ•´```System.gc();```åˆ°```fillHeap(1000);```ä¹‹å¤–åï¼Œ

![](https://ws2.sinaimg.cn/large/006tKfTcly1g0qenxk89ej31950u07nj.jpg)

ç›¸æ¯”jconsoleï¼Œæ¼‚äº®å¤šäº†ã€‚

#### è¯¾åä½œä¸š

ç»å…¸é¢è¯•é—®é¢˜: å¦‚ä½•ç›‘æ§å’Œè¯Šæ–­JVMå †å†…å’Œå †å¤–å†…å­˜ä½¿ç”¨ï¼Ÿ

## å‚è€ƒ

æ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºï¼šJVMé«˜çº§ç‰¹æ€§ä¸æœ€ä½³å®è·µï¼ˆç¬¬2ç‰ˆï¼‰